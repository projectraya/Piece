@page "/Account/Manage/Statistics"
@rendermode InteractiveServer
@using Piece.DTOs
@using Piece.Services
@inject ApplicationDbContext DbContext
@inject PlayerService PlayerService
@inject IListeningHistoryService ListeningHistoryService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Listening Statistics</PageTitle>

<style>
    .stats-container {
        margin-top: 20px;
    }

    .stats-section {
        background-color: #2a2a2a;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 24px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 20px;
    }

    .heatmap-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .heatmap-month {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .month-label {
        width: 80px;
        font-size: 12px;
        color: #888;
        text-align: right;
    }

    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .heatmap-day {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        background-color: #1a1a1a;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .heatmap-day:hover {
            transform: scale(1.3);
        }

        .heatmap-day.has-data {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

    .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        font-size: 12px;
        color: #888;
    }

    .top-genres {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .genre-card {
        background-color: #1a1a1a;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .genre-color {
        width: 40px;
        height: 40px;
        border-radius: 8px;
    }

    .genre-info h4 {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin: 0 0 5px 0;
    }

    .genre-info p {
        font-size: 14px;
        color: #888;
        margin: 0;
    }

    .track-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .stat-track-card {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 16px;
        display: grid;
        grid-template-columns: 60px 60px 1fr auto;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }

        .stat-track-card:hover {
            background: #3a3a3a;
            transform: translateX(5px);
        }

    .track-rank {
        font-size: 24px;
        font-weight: 700;
        color: #FFD335;
        text-align: center;
    }

    .track-time {
        font-size: 12px;
        color: #666;
        text-align: center;
    }

    .track-art-small {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #FFD335 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        overflow: hidden;
    }

        .track-art-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .track-details {
        min-width: 0;
    }

    .track-name {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .track-artist {
        font-size: 14px;
        color: #888;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .track-play-count {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .track-duration {
        font-size: 14px;
        color: #888;
    }
</style>

<div class="stats-container">
    @if (isLoading)
    {
        <p style="color: #888;">Loading statistics...</p>
    }
    else
    {
       
        <!-- Genre Heatmap -->
        <div class="stats-section">
            <h2 class="section-title">Listening History (Last 90 Days)</h2>
            <div class="heatmap-container">
                @foreach (var month in GetMonthsData())
                {
                    <div class="heatmap-month">
                        <div class="month-label">@month.Key</div>
                        <div class="heatmap-grid">
                            @foreach (var day in month.Value)
                            {
                                <div class="heatmap-day @(day.ColorCounts.Any() ? "has-data" : "")"
                                     style="background: @GetDayColor(day.ColorCounts);"
                                     title="@GetDayTooltip(day)">
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Genre Color Legend -->
            <div style="margin-top: 20px; padding: 15px; background-color: #1a1a1a; border-radius: 8px;">
                <p style="font-size: 12px; color: #888; margin-bottom: 10px;">Genre Colors:</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    @foreach (var genre in topGenres.Take(10))
                    {
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: @genre.Value.Color; border-radius: 3px;"></div>
                            <span style="font-size: 11px; color: #888;">@genre.Key</span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Top Genres -->
        <div class="stats-section">
            <h2 class="section-title">Top Genres (Last 30 Days)</h2>
            <div class="top-genres">
                @foreach (var genre in topGenres)
                {
                    <div class="genre-card">
                        <div class="genre-color" style="background-color: @genre.Value.Color;"></div>
                        <div class="genre-info">
                            <h4>@genre.Key</h4>
                            <p>@genre.Value.Count plays</p>
                        </div>
                    </div>
                }
            </div>
        </div>
        <!-- Most Played Tracks -->
        <div class="stats-section">
            <h2 class="section-title">Most Played Tracks (All Time)</h2>
            @if (mostPlayedTracks.Any())
            {
                <div class="track-list">
                    @foreach (var (track, index) in mostPlayedTracks.Select((t, i) => (t, i + 1)))
                    {
                        <div class="stat-track-card" @onclick="() => PlayTrack(track)">
                            <div class="track-rank">#@index</div>
                            <div class="track-art-small">
                                @if (!string.IsNullOrEmpty(track.CoverImageUrl))
                                {
                                    <img src="@track.CoverImageUrl" alt="@track.Title" />
                                }
                                else
                                {
                                    <span>🎵</span>
                                }
                            </div>
                            <div class="track-details">
                                <div class="track-name">@track.Title</div>
                                <div class="track-artist">@track.ArtistName</div>
                            </div>
                            <div class="track-play-count">
                                <span style="font-size: 18px; font-weight: 700; color: #FFD335;">@track.PlayCount</span>
                                <span style="font-size: 12px; color: #666;">plays</span>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 40px; color: #888;">
                    <p>No play history yet</p>
                </div>
            }
        </div>

        <!-- Recently Played -->
        <div class="stats-section">
            <h2 class="section-title">Recently Played</h2>
            @if (recentlyPlayed.Any())
            {
                <div class="track-list">
                    @foreach (var history in recentlyPlayed)
                    {
                        <div class="stat-track-card" @onclick="() => PlayTrack(history.Track)">
                            <div class="track-time">@GetTimeAgo(history.PlayedAt)</div>
                            <div class="track-art-small">
                                @if (!string.IsNullOrEmpty(history.Track.CoverImageUrl))
                                {
                                    <img src="@history.Track.CoverImageUrl" alt="@history.Track.Title" />
                                }
                                else
                                {
                                    <span>🎵</span>
                                }
                            </div>
                            <div class="track-details">
                                <div class="track-name">@history.Track.Title</div>
                                <div class="track-artist">@history.Track.ArtistName</div>
                            </div>
                            <div class="track-duration">
                                @TimeSpan.FromSeconds(history.DurationListened).ToString(@"mm\:ss")
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div style="text-align: center; padding: 40px; color: #888;">
                    <p>No recent plays</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? currentUserId;
    private Dictionary<DateTime, List<(string Color, int Count)>> genreHistory = new();
    private List<Track> mostPlayedTracks = new();
    private List<ListeningHistory> recentlyPlayed = new();

    private class DayData
    {
        public DateTime Date { get; set; }
        public List<(string Color, int Count)> ColorCounts { get; set; } = new();
    }
    private Dictionary<string, (int Count, string Color)> topGenres = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(currentUserId))
            {
                await LoadStatistics();
            }
        }

        isLoading = false;
    }

    private async Task LoadStatistics()
    {
        Console.WriteLine("[Statistics] Loading statistics...");

        var endDate = DateTime.UtcNow.Date;
        var startDate = endDate.AddDays(-90);

        // Load genre history
        genreHistory = await ListeningHistoryService.GetGenreHistoryAsync(currentUserId!, startDate, endDate);
        Console.WriteLine($"[Statistics] Loaded {genreHistory.Count} days with data");

        // Load top genres
        topGenres = await ListeningHistoryService.GetTopGenresAsync(currentUserId!, 30);
        Console.WriteLine($"[Statistics] Loaded {topGenres.Count} top genres");

        // Load most played tracks
        mostPlayedTracks = await DbContext.Tracks
            .Include(t => t.Genre)
            .Where(t => t.Source == TrackSource.Local)
            .OrderByDescending(t => t.PlayCount)
            .Take(10)
            .ToListAsync();

        // Load recently played
        recentlyPlayed = await DbContext.ListeningHistory
            .Include(h => h.Track)
                .ThenInclude(t => t.Genre)
            .Where(h => h.UserId == currentUserId && h.Track.Source == TrackSource.Local)
            .OrderByDescending(h => h.PlayedAt)
            .Take(20)
            .ToListAsync();
    }

   

    private Dictionary<string, List<DayData>> GetMonthsData()
    {
        var endDate = DateTime.UtcNow.Date;
        var startDate = endDate.AddDays(-90);

        var monthsData = new Dictionary<string, List<DayData>>();

        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            var monthKey = date.ToString("MMM yyyy");

            if (!monthsData.ContainsKey(monthKey))
            {
                monthsData[monthKey] = new List<DayData>();
            }

            var colorCounts = genreHistory.ContainsKey(date) ? genreHistory[date] : new List<(string, int)>();

            monthsData[monthKey].Add(new DayData
                {
                    Date = date,
                    ColorCounts = colorCounts
                });
        }

        return monthsData;
    }
    private void PlayTrack(Track track)
    {
        var playableTrack = PlayableTrack.FromLocalTrack(track, false);
        PlayerService.PlayTrack(playableTrack);
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return dateTime.ToString("MMM dd");
    }

    private string GetDayColor(List<(string Color, int Count)> colorCounts)
    {
        if (!colorCounts.Any())
            return "#1a1a1a";

        if (colorCounts.Count == 1)
            return colorCounts[0].Color;

        return BlendColorsWeighted(colorCounts);
    }

    private string BlendColorsWeighted(List<(string Color, int Count)> colorCounts)
    {
        if (!colorCounts.Any()) return "#1a1a1a";
        if (colorCounts.Count == 1) return colorCounts[0].Color;

        int totalR = 0, totalG = 0, totalB = 0;
        int totalCount = colorCounts.Sum(c => c.Count);

        foreach (var (hexColor, count) in colorCounts)
        {
            var color = hexColor.TrimStart('#');
            int r = Convert.ToInt32(color.Substring(0, 2), 16);
            int g = Convert.ToInt32(color.Substring(2, 2), 16);
            int b = Convert.ToInt32(color.Substring(4, 2), 16);

            // Weight by count
            totalR += r * count;
            totalG += g * count;
            totalB += b * count;
        }

        int avgR = totalR / totalCount;
        int avgG = totalG / totalCount;
        int avgB = totalB / totalCount;

        return $"#{avgR:X2}{avgG:X2}{avgB:X2}";
    }

    private string GetDayTooltip(DayData day)
    {
        if (!day.ColorCounts.Any())
            return $"{day.Date:MMM dd, yyyy} - No listening";

        var genreInfo = string.Join(", ", day.ColorCounts.Select(c => $"{c.Count} plays"));
        return $"{day.Date:MMM dd, yyyy} - {genreInfo}";
    }

    

    
}