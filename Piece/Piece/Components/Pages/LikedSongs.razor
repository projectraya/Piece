@page "/liked-songs"
@rendermode InteractiveServer
@using Piece.Data.Enums
@using Piece.DTOs
@using Piece.Services
@inject IFavoriteService FavoriteService
@inject PlayerService PlayerService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<PageTitle>Liked Songs - Piece</PageTitle>

<style>
    
    body {
        margin: 0;
        padding: 0;
        background-color: #1a1a1a;
    }

    .liked-songs-container {
        padding: 30px;
        background-color: #1a1a1a;
        min-height: 100vh;
        margin: 0; /* Add this */
    }
    .liked-songs-container {
        padding: 30px;
        background-color: #1a1a1a;
        min-height: 100vh;
    }

    .liked-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 30px;
    }

    .liked-icon {
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 80px;
    }

    .liked-info h1 {
        font-size: 48px;
        font-weight: 700;
        color: #ffffff;
        margin: 0 0 10px 0;
    }

    .liked-info p {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        margin: 0;
    }

    .filter-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
    }

    .filter-tab {
        padding: 10px 20px;
        background-color: #2a2a2a;
        border: none;
        border-radius: 20px;
        color: #888;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .filter-tab.active {
            background-color: #667eea;
            color: #ffffff;
        }

        .filter-tab:hover:not(.active) {
            background-color: #3a3a3a;
            color: #ffffff;
        }

    .track-list {
        background-color: #2a2a2a;
        border-radius: 16px;
        overflow: hidden;
    }

    .track-row {
        display: grid;
        grid-template-columns: 50px 1fr 200px 100px 60px;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #3a3a3a;
        cursor: pointer;
        transition: background-color 0.3s;
    }

        .track-row:hover {
            background-color: #3a3a3a;
        }

        .track-row.playing {
            background-color: #4a4a4a;
        }

    .track-number {
        color: #888;
        font-size: 14px;
        text-align: center;
    }

    .track-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .track-album-art {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

        .track-album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

    .track-details h4 {
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
        margin: 0 0 4px 0;
    }

    .track-details p {
        font-size: 12px;
        color: #888;
        margin: 0;
    }

    .track-source {
        font-size: 12px;
        color: #888;
    }

    .track-date {
        font-size: 12px;
        color: #888;
    }

    .track-actions {
        display: flex;
        justify-content: center;
    }

    .unlike-btn {
        background: none;
        border: none;
        color: #ff4444;
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .unlike-btn:hover {
            transform: scale(1.2);
        }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #888;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        color: #888;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #3a3a3a;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="liked-songs-container">
    <!-- Header -->
    <div class="liked-header">
        <div class="liked-icon">❤️</div>
        <div class="liked-info">
            <h1>Liked Songs</h1>
            <p>@totalCount songs • Mix of local and Jamendo tracks</p>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Loading your liked songs...</p>
        </div>
    }
    else
    {
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab @(activeFilter == "all" ? "active" : "")"
                    @onclick='() => SetFilter("all")'>
                All (@totalCount)
            </button>
            <button class="filter-tab @(activeFilter == "local" ? "active" : "")"
                    @onclick='() => SetFilter("local")'>
                Local (@localFavorites.Count)
            </button>
            <button class="filter-tab @(activeFilter == "jamendo" ? "active" : "")"
                    @onclick='() => SetFilter("jamendo")'>
                Jamendo (@jamendoFavorites.Count)
            </button>
        </div>

        @if (filteredTracks.Any())
        {
            <!-- Track List -->
            <div class="track-list">
                @{
                    int index = 1;
                }
                @foreach (var track in filteredTracks)
                {
                    <div class="track-row @(IsPlaying(track) ? "playing" : "")"
                         @onclick="() => PlayTrack(track)">
                        <div class="track-number">@index</div>
                        <div class="track-info">
                            <div class="track-album-art">
                                @if (!string.IsNullOrEmpty(track.AlbumImage))
                                {
                                    <img src="@track.AlbumImage" alt="@track.Title" />
                                }
                                else
                                {
                                    <span>🎵</span>
                                }
                            </div>
                            <div class="track-details">
                                <h4>@track.Title</h4>
                                <p>@track.ArtistName</p>
                            </div>
                        </div>
                        <div class="track-source">@track.Source</div>
                        <div class="track-date">@track.LikedAt.ToString("MMM dd, yyyy")</div>
                        <div class="track-actions">
                            <button class="unlike-btn"
                                    @onclick="(e) => UnlikeTrack(e, track)"
                                    @onclick:stopPropagation="true">
                                ❤️
                            </button>
                        </div>
                    </div>
                    index++;
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">💔</div>
                <h3>No liked songs yet</h3>
                <p>Songs you like will appear here</p>
            </div>
        }
    }
</div>

@code {
    private List<LikedTrackViewModel> localFavorites = new();
    private List<LikedTrackViewModel> jamendoFavorites = new();
    private List<LikedTrackViewModel> filteredTracks = new();
    private int totalCount = 0;
    private string activeFilter = "all";
    private bool isLoading = true;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(currentUserId))
        {
            await LoadLikedSongs();
        }

        isLoading = false;
    }

    private async Task LoadLikedSongs()
    {
        try
        {
            // Load local favorites
            var localTracks = await FavoriteService.GetUserFavoritesAsync(currentUserId!);
            localFavorites = localTracks
                .Where(t => t.Source == TrackSource.Local)
                .Select(t => new LikedTrackViewModel
                {
                    Id = $"local-{t.Id}",
                    Title = t.Title,
                    ArtistName = t.ArtistName,
                    AlbumImage = t.CoverImageUrl, // Add this
                    AudioUrl = t.LocalFilePath,
                    Source = TrackSource.Local,
                    LocalTrackId = t.Id,
                    LikedAt = DateTime.UtcNow
                })
            .ToList();

            // Load Jamendo favorites
            var externalFavorites = await FavoriteService.GetUserExternalFavoritesAsync(currentUserId!, TrackSource.Jamendo);
            jamendoFavorites = externalFavorites.Select(f => new LikedTrackViewModel
                {
                    Id = $"jamendo-{f.ExternalId}",
                    Title = f.Title,
                    ArtistName = f.ArtistName,
                    AlbumImage = f.AlbumImage,
                    AudioUrl = f.AudioUrl,
                    Source = TrackSource.Jamendo,
                    ExternalId = f.ExternalId,
                    LikedAt = f.LikedAt
                }).ToList();

            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading liked songs: {ex.Message}");
        }
    }

    private void SetFilter(string filter)
    {
        activeFilter = filter;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        filteredTracks = activeFilter switch
        {
            "local" => localFavorites,
            "jamendo" => jamendoFavorites,
            _ => localFavorites.Concat(jamendoFavorites).OrderByDescending(t => t.LikedAt).ToList()
        };

        totalCount = localFavorites.Count + jamendoFavorites.Count;
        StateHasChanged();
    }

    private void PlayTrack(LikedTrackViewModel track)
    {
        var playableTrack = new PlayableTrack
            {
                Id = track.Id,
                Title = track.Title,
                ArtistName = track.ArtistName,
                AudioUrl = track.AudioUrl,
                AlbumImage = track.AlbumImage,
                Source = track.Source,
                LocalTrackId = track.LocalTrackId,
                IsFavorite = true // Already favorited
            };

        PlayerService.PlayTrack(playableTrack);
    }

    private async Task UnlikeTrack(MouseEventArgs e, LikedTrackViewModel track)
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        try
        {
            if (track.Source == TrackSource.Local && track.LocalTrackId.HasValue)
            {
                await FavoriteService.ToggleFavoriteAsync(currentUserId, track.LocalTrackId.Value);
            }
            else if (track.Source == TrackSource.Jamendo && !string.IsNullOrEmpty(track.ExternalId))
            {
                await FavoriteService.ToggleExternalFavoriteAsync(
                    currentUserId,
                    TrackSource.Jamendo,
                    track.ExternalId,
                    track.Title,
                    track.ArtistName,
                    track.AudioUrl,
                    track.AlbumImage
                );
            }

            // Reload the list
            await LoadLikedSongs();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error unliking track: {ex.Message}");
        }
    }

    private bool IsPlaying(LikedTrackViewModel track)
    {
        return PlayerService.CurrentTrack?.Id == track.Id;
    }

    // ViewModel for displaying liked tracks
    
}