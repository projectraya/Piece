@using Piece.Data.Enums
@using Piece.DTOs
@using Piece.Services
@using System;
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IFavoriteService FavoriteService
@inject PlayerService PlayerService
@inject IJSRuntime JSRuntime
@implements IDisposable


@if (PlayerService.CurrentTrack != null)
{
    <div style="position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 100px;
                background-color: #2a2a2a;
                border-top: 1px solid #3a3a3a;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 30px;
                z-index: 9999;">

        <!-- Left: Now Playing Info -->
        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
            <div style="width: 60px;
                        height: 60px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        overflow: hidden;">
                @if (!string.IsNullOrEmpty(PlayerService.CurrentTrack.AlbumImage))
                {
                    <img src="@PlayerService.CurrentTrack.AlbumImage"
                    alt="@PlayerService.CurrentTrack.Title"
                    style="width: 100%; height: 100%; object-fit: cover;" />
                }
                else
                {
                    <span>🎵</span>
                }
            </div>
            <div>
                <h4 style="font-size: 14px; font-weight: 600; margin: 0; color: #ffffff;">
                    @PlayerService.CurrentTrack.Title
                </h4>
                <p style="font-size: 12px; color: #888; margin: 2px 0 0 0;">
                    @PlayerService.CurrentTrack.ArtistName
                    @if (PlayerService.CurrentTrack.Source == TrackSource.Jamendo)
                    {
                        <span style="color: #667eea; margin-left: 8px;">• Jamendo</span>
                    }
                </p>
            </div>
        </div>

        <!-- Center: Player Controls & Audio -->
        <div style="flex: 2; display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <button @onclick="PlayerService.PlayPrevious"
                        style="background: none; border: none; color: #ffffff; font-size: 32px; cursor: pointer;">
                    ⏮
                </button>
                <button @onclick="TogglePlayPause"
                        style="background: none; border: none; color: #ffffff; font-size: 40px; cursor: pointer;">
                    @(PlayerService.IsPlaying ? "⏸" : "▶")
                </button>
                <button @onclick="PlayerService.PlayNext"
                        style="background: none; border: none; color: #ffffff; font-size: 32px; cursor: pointer;">
                    ⏭
                </button>
            </div>

            <!-- Custom Progress Bar -->
            <div style="width: 100%; max-width: 500px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 12px; color: #888; min-width: 40px;">@currentTime</span>
                <div @onclick="SeekTo"
                     class="progress-bar-container"
                     style="flex: 1;
                    height: 6px;
                    background-color: #3a3a3a;
                    border-radius: 3px;
                    cursor: pointer;
                    position: relative;">
                    <div style="width: @((int)progressPercent)%;
                        height: 100%;
                        background-color: #667eea;
                        border-radius: 3px;
                        transition: width 0.1s;"></div>
                </div>
                <span style="font-size: 12px; color: #888; min-width: 40px;">@totalTime</span>
            </div>

            @* Hidden audio element *@
            <audio @key="PlayerService.CurrentTrack.Id"
                   id="globalAudioPlayer"
                   autoplay
                   @ref="audioElement"
                   @onended="OnTrackEnded"
                  
                   style="display: none;">
                <source src="@PlayerService.CurrentTrack.AudioUrl" type="audio/mpeg" />
            </audio>
        </div>

        <!-- Right: Extra Controls -->
        <div style="display: flex; align-items: center; gap: 20px; flex: 1; justify-content: flex-end;">
            <button @onclick="ToggleFavorite"
                    style="background: none;
                   border: none;
                   color: @(PlayerService.CurrentTrack.IsFavorite ? "#ff4444" : "#888");
                   font-size: 24px;
                   cursor: pointer;
                   transition: all 0.3s;">
                @(PlayerService.CurrentTrack.IsFavorite ? "❤" : "🤍")
            </button>
            <button style="background: none; border: none; color: #888; font-size: 24px; cursor: pointer;">🔊</button>
        </div>
    </div>
}

@code {
    private ElementReference audioElement;
    private string currentTime = "0:00";
    private string totalTime = "0:00";
    private double progressPercent = 0;
    private double duration = 0;
    private double currentPosition = 0;
    private string? currentUserId;
    private System.Threading.Timer? progressTimer;

    protected override async Task OnInitializedAsync()
    {
        PlayerService.OnChange += StateHasChanged;
        PlayerService.OnTrackChanged += OnTrackChanged;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }

        // Start progress timer
        progressTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await UpdateProgress();
            });
        }, null, 0, 500); // Update every 500ms
    }

    private void OnTrackChanged()
    {
        Console.WriteLine($"[GlobalPlayer] Track changed to: {PlayerService.CurrentTrack?.Title}");
        currentTime = "0:00";
        totalTime = "0:00";
        progressPercent = 0;
        StateHasChanged();
    }

    private async Task UpdateProgress()
    {
        if (PlayerService.CurrentTrack == null) return;

        try
        {
            var timeData = await JSRuntime.InvokeAsync<TimeData>("eval", @"
            (function() {
                var audio = document.getElementById('globalAudioPlayer');
                if (audio && !isNaN(audio.duration)) {
                    return {
                        currentTime: audio.currentTime,
                        duration: audio.duration
                    };
                }
                return { currentTime: 0, duration: 0 };
            })()
        ");

            currentPosition = timeData.CurrentTime;
            duration = timeData.Duration;

            if (duration > 0)
            {
                progressPercent = (currentPosition / duration) * 100;
                currentTime = FormatTime(currentPosition);
                totalTime = FormatTime(duration);
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Progress] Error: {ex.Message}");
        }
    }


    private async Task ToggleFavorite()
    {
        Console.WriteLine("[GlobalPlayer] ToggleFavorite called");

        if (string.IsNullOrEmpty(currentUserId))
        {
            Console.WriteLine("[GlobalPlayer] No currentUserId - user not logged in?");
            return;
        }

        if (PlayerService.CurrentTrack == null)
        {
            Console.WriteLine("[GlobalPlayer] No current track");
            return;
        }

        Console.WriteLine($"[GlobalPlayer] Toggling favorite for: {PlayerService.CurrentTrack.Title}, Source: {PlayerService.CurrentTrack.Source}");

        try
        {
            bool isFavorite = false;

            if (PlayerService.CurrentTrack.Source == TrackSource.Local &&
                PlayerService.CurrentTrack.LocalTrackId.HasValue)
            {
                Console.WriteLine("[GlobalPlayer] Processing local track");
                isFavorite = await FavoriteService.ToggleFavoriteAsync(
                    currentUserId,
                    PlayerService.CurrentTrack.LocalTrackId.Value
                );
            }
            else if (PlayerService.CurrentTrack.Source == TrackSource.Jamendo)
            {
                Console.WriteLine("[GlobalPlayer] Processing Jamendo track");
                var jamendoId = PlayerService.CurrentTrack.Id.Replace("jamendo-", "");
                Console.WriteLine($"[GlobalPlayer] Jamendo ID: {jamendoId}");

                isFavorite = await FavoriteService.ToggleExternalFavoriteAsync(
                    currentUserId,
                    TrackSource.Jamendo,
                    jamendoId,
                    PlayerService.CurrentTrack.Title,
                    PlayerService.CurrentTrack.ArtistName,
                    PlayerService.CurrentTrack.AudioUrl,
                    PlayerService.CurrentTrack.AlbumImage
                );

                Console.WriteLine($"[GlobalPlayer] ToggleExternalFavoriteAsync returned: {isFavorite}");
            }

            PlayerService.UpdateFavoriteStatus(isFavorite);
            Console.WriteLine($"[GlobalPlayer] Track {(isFavorite ? "liked" : "unliked")} - updating UI");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[GlobalPlayer] Error toggling favorite: {ex.Message}");
            Console.WriteLine($"[GlobalPlayer] Stack trace: {ex.StackTrace}");
        }
    }

    private async Task SeekTo(MouseEventArgs e)
    {
        try
        {
            var clickX = e.OffsetX;
            var width = await JSRuntime.InvokeAsync<double>("eval",
                "document.querySelector('.progress-bar-container').offsetWidth");

            var seekPercent = clickX / width;
            var seekTime = duration * seekPercent;

            await JSRuntime.InvokeVoidAsync("eval", $@"
            var audio = document.getElementById('globalAudioPlayer');
            if (audio) {{
                audio.currentTime = {seekTime.ToString(System.Globalization.CultureInfo.InvariantCulture)};
            }}
        ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Seek error: {ex.Message}");
        }
    }

    private string FormatTime(double seconds)
    {
        if (double.IsNaN(seconds) || double.IsInfinity(seconds))
            return "0:00";

        var time = TimeSpan.FromSeconds(seconds);
        return time.Hours > 0
            ? $"{time.Hours}:{time.Minutes:D2}:{time.Seconds:D2}"
            : $"{time.Minutes}:{time.Seconds:D2}";
    }

    private async Task TogglePlayPause()
    {
        PlayerService.TogglePlayPause();

        await JSRuntime.InvokeVoidAsync("eval", @"
            var audio = document.getElementById('globalAudioPlayer');
            if (audio) {
                if (audio.paused) {
                    audio.play().catch(e => console.error('Play failed:', e));
                } else {
                    audio.pause();
                }
            }
        ");
    }

    private void OnTrackEnded()
    {
        Console.WriteLine("[GlobalPlayer] Track ended");
        PlayerService.PlayNext();
    }

    public void Dispose()
    {
        PlayerService.OnChange -= StateHasChanged;
        PlayerService.OnTrackChanged -= OnTrackChanged;
        progressTimer?.Dispose();
    }

    private class TimeData
    {
        public double CurrentTime { get; set; }
        public double Duration { get; set; }
    }
}